<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Admin - Inventur</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .search-box { max-width: 300px; }
    </style>
</head>
<body class="bg-light p-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üõ°Ô∏è Admin Dashboard</h2>
        <div>
            <button onclick="exportToCSV()" class="btn btn-success">
                üíæ Aktuelle Ansicht als .csv
            </button>
            <a href="/" class="btn btn-outline-secondary ms-2">Zum Formular</a>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-pane" type="button">
                üì¶ Einzelansicht (Nach Submit)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="total-tab" data-bs-toggle="tab" data-bs-target="#total-pane" type="button">
                üìã Gesamtansicht (Alle)
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">

        <div class="tab-pane fade show active bg-white p-3 border border-top-0" id="single-pane">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">W√§hle eine Einreichung:</label>
                    <select id="submissionSelect" class="form-select">
                        <option value="">Bitte w√§hlen...</option>
                        </select>
                </div>
                <div class="col-md-6 text-end">
                    <label class="form-label">&nbsp;</label>
                    <input type="text" id="searchSingle" class="form-control search-box float-end" placeholder="üîç Diese Liste filtern...">
                </div>
            </div>

            <div id="singleInfo" class="alert alert-info d-none">
                </div>

            <table class="table table-striped table-hover" id="tableSingle">
                <thead class="table-dark">
                    <tr><th>Ger√§te-ID</th><th>Geb√§ude</th><th>Raum</th></tr>
                </thead>
                <tbody id="singleTableBody">
                    <tr><td colspan="3" class="text-center text-muted">W√§hle einen Eintrag aus dem Men√º.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="tab-pane fade bg-white p-3 border border-top-0" id="total-pane">
            <div class="mb-3 d-flex justify-content-end">
                <input type="text" id="searchTotal" class="form-control search-box" placeholder="üîç Alles durchsuchen...">
            </div>
            <table class="table table-sm table-striped table-hover" id="tableTotal">
                <thead class="table-dark">
                    <tr>
                        <th>Datum</th>
                        <th>Verantwortlicher</th>
                        <th>Abteilung</th>
                        <th>Ger√§te-ID</th>
                        <th>Geb√§ude</th>
                        <th>Raum</th>
                    </tr>
                </thead>
                <tbody id="totalTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allData = [];

        // Daten laden
        async function loadData() {
            const res = await fetch('/admin/data');
            if (res.status === 401) {
                alert("Nicht autorisiert!");
                window.location.reload();
                return;
            }
            allData = await res.json();
            initTotalView();
            initSingleView();
        }

        // --- EXPORT FUNKTION (NEU) ---
        function exportToCSV() {
            // 1. Pr√ºfen welcher Tab aktiv ist
            const isTotalTab = document.getElementById('total-tab').classList.contains('active');
            const tableId = isTotalTab ? 'tableTotal' : 'tableSingle';
            const table = document.getElementById(tableId);

            let csvContent = "data:text/csv;charset=utf-8,";

            // 2. Header holen
            const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText);
            csvContent += headers.join(";") + "\r\n";

            // 3. Sichtbare Zeilen iterieren
            const rows = table.querySelectorAll("tbody tr");
            let count = 0;

            rows.forEach(row => {
                // Nur exportieren, wenn nicht ausgeblendet (durch Suche)
                if (row.style.display !== 'none') {
                    const cols = Array.from(row.querySelectorAll("td")).map(td => {
                        // Text bereinigen (Semikolons entfernen, damit CSV nicht bricht)
                        return td.innerText.replace(/;/g, ",");
                    });

                    // Leere Platzhalter-Zeilen ignorieren
                    if(cols.length > 1 || (cols.length === 1 && cols[0] !== "W√§hle einen Eintrag aus dem Men√º.")) {
                        csvContent += cols.join(";") + "\r\n";
                        count++;
                    }
                }
            });

            if (count === 0) {
                alert("Keine Daten zum Exportieren sichtbar!");
                return;
            }

            // 4. Download triggern
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", isTotalTab ? "inventur_gesamt_gefiltert.csv" : "inventur_einzel_gefiltert.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- VIEWS INITIALISIEREN ---
        function initTotalView() {
            const tbody = document.getElementById('totalTableBody');
            tbody.innerHTML = '';

            allData.forEach(row => {
                const date = new Date(row.timestamp).toLocaleString();
                tbody.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${row.verantwortlicher}</td>
                        <td>${row.abteilung}</td>
                        <td><strong>${row.geraete_id}</strong></td>
                        <td>${row.gebaeude}</td>
                        <td>${row.raum}</td>
                    </tr>
                `;
            });
        }

        function initSingleView() {
            const groups = {};
            allData.forEach(item => {
                if(!groups[item.submission_id]) {
                    groups[item.submission_id] = { header: item, items: [] };
                }
                groups[item.submission_id].items.push(item);
            });

            const select = document.getElementById('submissionSelect');
            Object.values(groups).forEach(group => {
                const h = group.header;
                const date = new Date(h.timestamp).toLocaleString();
                const option = document.createElement('option');
                option.value = h.submission_id;
                option.text = `${date} - ${h.verantwortlicher} (${h.abteilung})`;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                const subId = e.target.value;
                const tbody = document.getElementById('singleTableBody');
                const infoBox = document.getElementById('singleInfo');

                if(!subId) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">W√§hle einen Eintrag aus dem Men√º.</td></tr>';
                    infoBox.classList.add('d-none');
                    return;
                }

                const group = groups[subId];
                infoBox.innerHTML = `
                    <strong>Eingereicht am:</strong> ${new Date(group.header.timestamp).toLocaleString()} <br>
                    <strong>Von:</strong> ${group.header.verantwortlicher} (${group.header.abteilung})
                `;
                infoBox.classList.remove('d-none');

                tbody.innerHTML = '';
                group.items.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${item.geraete_id}</strong></td>
                            <td>${item.gebaeude}</td>
                            <td>${item.raum}</td>
                        </tr>
                    `;
                });
            });
        }

        // --- SUCHFUNKTION ---
        function setupSearch(inputId, tableBodyId) {
            document.getElementById(inputId).addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll(`#${tableBodyId} tr`);

                rows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            });
        }

        setupSearch('searchTotal', 'totalTableBody');
        setupSearch('searchSingle', 'singleTableBody');

        window.onload = loadData;
    </script>
</body>
</html>